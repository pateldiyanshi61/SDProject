services:
  # ---------- REDIS CACHE ----------
  redis:
    image: redis:7-alpine
    container_name: redis-cache
    command: redis-server --maxmemory 10mb --maxmemory-policy allkeys-lru --appendonly no
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - backend-net
    pull_policy: missing

  # ---------- NGINX REVERSE PROXY ----------
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      auth-service:
        condition: service_healthy
      account-service:
        condition: service_healthy
      transaction-service:
        condition: service_healthy
      notification-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
    pull_policy: missing

  # ---------- RABBITMQ ----------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend-net
    pull_policy: missing

  # ---------- CONFIG SERVERS (3 replicas) ----------
  config1:
    image: mongo:6.0.18
    container_name: config1
    command: mongod --configsvr --replSet configReplSet --port 27017 --bind_ip_all
    volumes:
      - config1-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  config2:
    image: mongo:6.0
    container_name: config2
    command: mongod --configsvr --replSet configReplSet --port 27017 --bind_ip_all
    volumes:
      - config2-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  config3:
    image: mongo:6.0
    container_name: config3
    command: mongod --configsvr --replSet configReplSet --port 27017 --bind_ip_all
    volumes:
      - config3-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  # ---------- SHARD 1 (3 replicas) ----------
  shard1a:
    image: mongo:6.0
    container_name: shard1a
    command: mongod --shardsvr --replSet shard1Repl --port 27017 --bind_ip_all
    volumes:
      - shard1a-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  shard1b:
    image: mongo:6.0
    container_name: shard1b
    command: mongod --shardsvr --replSet shard1Repl --port 27017 --bind_ip_all
    volumes:
      - shard1b-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  shard1c:
    image: mongo:6.0
    container_name: shard1c
    command: mongod --shardsvr --replSet shard1Repl --port 27017 --bind_ip_all
    volumes:
      - shard1c-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  # ---------- SHARD 2 (3 replicas) ----------
  shard2a:
    image: mongo:6.0
    container_name: shard2a
    command: mongod --shardsvr --replSet shard2Repl --port 27017 --bind_ip_all
    volumes:
      - shard2a-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  shard2b:
    image: mongo:6.0
    container_name: shard2b
    command: mongod --shardsvr --replSet shard2Repl --port 27017 --bind_ip_all
    volumes:
      - shard2b-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  shard2c:
    image: mongo:6.0
    container_name: shard2c
    command: mongod --shardsvr --replSet shard2Repl --port 27017 --bind_ip_all
    volumes:
      - shard2c-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  # ---------- SHARD 3 (3 replicas) ----------
  shard3a:
    image: mongo:6.0
    container_name: shard3a
    command: mongod --shardsvr --replSet shard3Repl --port 27017 --bind_ip_all
    volumes:
      - shard3a-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  shard3b:
    image: mongo:6.0
    container_name: shard3b
    command: mongod --shardsvr --replSet shard3Repl --port 27017 --bind_ip_all
    volumes:
      - shard3b-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  shard3c:
    image: mongo:6.0
    container_name: shard3c
    command: mongod --shardsvr --replSet shard3Repl --port 27017 --bind_ip_all
    volumes:
      - shard3c-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27017", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net
    pull_policy: missing

  # ---------- INIT REPLICA SETS ----------
  init-replica-sets:
    image: mongo:6.0
    container_name: init-replica-sets
    depends_on:
      config1:
        condition: service_healthy
      config2:
        condition: service_healthy
      config3:
        condition: service_healthy
      shard1a:
        condition: service_healthy
      shard1b:
        condition: service_healthy
      shard1c:
        condition: service_healthy
      shard2a:
        condition: service_healthy
      shard2b:
        condition: service_healthy
      shard2c:
        condition: service_healthy
      shard3a:
        condition: service_healthy
      shard3b:
        condition: service_healthy
      shard3c:
        condition: service_healthy
    entrypoint: >
      bash -c "
      echo '=== Waiting for MongoDB instances to be ready ===' &&
      sleep 10 &&

      echo '=== Initializing Config Server Replica Set ===' &&
      mongosh --host config1:27017 --quiet --eval '
        try {
          var status = rs.status();
          print(\"Config server already initialized\");
        } catch (e) {
          if (e.codeName === \"NotYetInitialized\") {
            rs.initiate({
              _id: \"configReplSet\",
              configsvr: true,
              members: [
                { _id: 0, host: \"config1:27017\" },
                { _id: 1, host: \"config2:27017\" },
                { _id: 2, host: \"config3:27017\" }
              ]
            });
            print(\"Config server replica set initiated\");
          } else {
            throw e;
          }
        }
      ' &&

      echo '=== Waiting for config server PRIMARY ===' &&
      until mongosh --host config1:27017 --quiet --eval \"rs.status().myState\" | grep -q \"1\"; do
        echo \"Waiting for config server to become PRIMARY...\"
        sleep 3
      done &&
      echo \"Config server is PRIMARY\" &&

      echo '=== Initializing Shard1 Replica Set ===' &&
      mongosh --host shard1a:27017 --quiet --eval '
        try {
          var status = rs.status();
          print(\"Shard1 already initialized\");
        } catch (e) {
          if (e.codeName === \"NotYetInitialized\") {
            rs.initiate({
              _id: \"shard1Repl\",
              members: [
                { _id: 0, host: \"shard1a:27017\" },
                { _id: 1, host: \"shard1b:27017\" },
                { _id: 2, host: \"shard1c:27017\" }
              ]
            });
            print(\"Shard1 replica set initiated\");
          } else {
            throw e;
          }
        }
      ' &&

      echo '=== Waiting for shard1 PRIMARY ===' &&
      until mongosh --host shard1a:27017 --quiet --eval \"rs.status().myState\" | grep -q \"1\"; do
        echo \"Waiting for shard1 to become PRIMARY...\"
        sleep 3
      done &&
      echo \"Shard1 is PRIMARY\" &&

      echo '=== Initializing Shard2 Replica Set ===' &&
      mongosh --host shard2a:27017 --quiet --eval '
        try {
          var status = rs.status();
          print(\"Shard2 already initialized\");
        } catch (e) {
          if (e.codeName === \"NotYetInitialized\") {
            rs.initiate({
              _id: \"shard2Repl\",
              members: [
                { _id: 0, host: \"shard2a:27017\" },
                { _id: 1, host: \"shard2b:27017\" },
                { _id: 2, host: \"shard2c:27017\" }
              ]
            });
            print(\"Shard2 replica set initiated\");
          } else {
            throw e;
          }
        }
      ' &&

      echo '=== Waiting for shard2 PRIMARY ===' &&
      until mongosh --host shard2a:27017 --quiet --eval \"rs.status().myState\" | grep -q \"1\"; do
        echo \"Waiting for shard2 to become PRIMARY...\"
        sleep 3
      done &&
      echo \"Shard2 is PRIMARY\" &&

      echo '=== Initializing Shard3 Replica Set ===' &&
      mongosh --host shard3a:27017 --quiet --eval '
        try {
          var status = rs.status();
          print(\"Shard3 already initialized\");
        } catch (e) {
          if (e.codeName === \"NotYetInitialized\") {
            rs.initiate({
              _id: \"shard3Repl\",
              members: [
                { _id: 0, host: \"shard3a:27017\" },
                { _id: 1, host: \"shard3b:27017\" },
                { _id: 2, host: \"shard3c:27017\" }
              ]
            });
            print(\"Shard3 replica set initiated\");
          } else {
            throw e;
          }
        }
      ' &&

      echo '=== Waiting for shard3 PRIMARY ===' &&
      until mongosh --host shard3a:27017 --quiet --eval \"rs.status().myState\" | grep -q \"1\"; do
        echo \"Waiting for shard3 to become PRIMARY...\"
        sleep 3
      done &&
      echo \"Shard3 is PRIMARY\" &&

      echo '=== All replica sets initialized and ready ===' &&
      sleep 5
      "
    networks:
      - mongo-net
    pull_policy: missing

  # ---------- MONGOS ROUTER ----------
  mongos:
    image: mongo:6.0
    container_name: mongos
    depends_on:
      init-replica-sets:
        condition: service_completed_successfully
    command: mongos --configdb configReplSet/config1:27017,config2:27017,config3:27017 --bind_ip_all --port 27017
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - mongo-net
      - backend-net
    pull_policy: missing

  # ---------- INIT SHARDING ----------
  init-sharding:
    image: mongo:6.0
    container_name: init-sharding
    depends_on:
      mongos:
        condition: service_healthy
    volumes:
      - ./init-sharding.js:/init-sharding.js:ro
      - ./init-shard-entrypoint.sh:/init-shard-entrypoint.sh:ro
      - shard-dumps:/tmp/shard_dumps
    entrypoint: ["/bin/bash", "/init-shard-entrypoint.sh"]
    environment:
      - AUTO_CLEAN=false
      - MONGOS_HOST=mongos:27017
      - 'SHARD_HOSTS=shard1a:27017 shard2a:27017 shard3a:27017'
      - DB_TO_CHECK=banking
    networks:
      - mongo-net
    pull_policy: missing

  # ---------- AUTH SERVICE ----------
  auth-service:
    build: ./auth-service
    container_name: auth-service
    depends_on:
      init-sharding:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - MONGO_URI=mongodb://mongos:27017
      - JWT_SECRET=your_super_secret_jwt_key_change_in_production
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8000:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
      - mongo-net

  # ---------- API GATEWAY ----------
  api-gateway:
    build: ./api-gateway-service
    container_name: api-gateway
    ports:
      - "9000:8000"
    environment:
      - AUTH_SERVICE_URL=http://auth-service:8000
      - ACCOUNT_SERVICE_URL=http://account-service:8001
      - TRANSACTION_SERVICE_URL=http://transaction-service:8002
      - NOTIFICATION_SERVICE_URL=http://notification-service:8003
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      account-service:
        condition: service_healthy
      transaction-service:
        condition: service_healthy
      notification-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net

  # ---------- ACCOUNT SERVICE ----------
  account-service:
    build: ./account-service
    container_name: account-service
    depends_on:
      auth-service:
        condition: service_healthy
      init-sharding:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    environment:
      - MONGO_URI=mongodb://mongos:27017
      - JWT_SECRET=your_super_secret_jwt_key_change_in_production
      - AUTH_SERVICE_URL=http://auth-service:8000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8001:8001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
      - mongo-net

  # ---------- TRANSACTION SERVICE ----------
  transaction-service:
    build: ./transaction-service
    container_name: transaction-service
    depends_on:
      account-service:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - MONGO_URI=mongodb://mongos:27017
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - JWT_SECRET=your_super_secret_jwt_key_change_in_production
      - AUTH_SERVICE_URL=http://auth-service:8000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8002:8002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
      - mongo-net

  # ---------- NOTIFICATION SERVICE ----------
  notification-service:
    build: ./notification-service
    container_name: notification-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      init-sharding:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    environment:
      - MONGO_URI=mongodb://mongos:27017
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - JWT_SECRET=your_super_secret_jwt_key_change_in_production
      - AUTH_SERVICE_URL=http://auth-service:8000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    ports:
      - "8003:8003"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
      - mongo-net

networks:
  backend-net:
    driver: bridge
  mongo-net:
    driver: bridge

volumes:
  config1-data:
  config2-data:
  config3-data:
  shard1a-data:
  shard1b-data:
  shard1c-data:
  shard2a-data:
  shard2b-data:
  shard2c-data:
  shard3a-data:
  shard3b-data:
  shard3c-data:
  shard-dumps: