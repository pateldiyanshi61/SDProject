version: '3.8'

services:
  # ---------- RABBITMQ ----------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend-net

  # ---------- CONFIG SERVER ----------
  configsvr:
    image: mongo:6.0
    container_name: configsvr
    command: mongod --configsvr --replSet configReplSet --port 27019 --bind_ip_all
    volumes:
      - configsvr-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27019", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net

  # ---------- SHARD 1 ----------
  shard1:
    image: mongo:6.0
    container_name: shard1
    command: mongod --shardsvr --replSet shard1ReplSet --port 27018 --bind_ip_all
    volumes:
      - shard1-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27018", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net

  # ---------- SHARD 2 ----------
  shard2:
    image: mongo:6.0
    container_name: shard2
    command: mongod --shardsvr --replSet shard2ReplSet --port 27018 --bind_ip_all
    volumes:
      - shard2-data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--port", "27018", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    networks:
      - mongo-net

  # ---------- INIT REPLICA SETS ----------
  init-replica-sets:
    image: mongo:6.0
    container_name: init-replica-sets
    depends_on:
      configsvr:
        condition: service_healthy
      shard1:
        condition: service_healthy
      shard2:
        condition: service_healthy
    entrypoint: >
      bash -c "
      echo '=== Waiting for MongoDB instances to be ready ===' &&
      sleep 10 &&

      echo '=== Initializing Config Server Replica Set ===' &&
      mongosh --host configsvr:27019 --quiet --eval '
        try {
          var status = rs.status();
          print(\"Config server already initialized\");
        } catch (e) {
          if (e.codeName === \"NotYetInitialized\") {
            rs.initiate({
              _id: \"configReplSet\",
              configsvr: true,
              members: [{ _id: 0, host: \"configsvr:27019\" }]
            });
            print(\"Config server replica set initiated\");
          } else {
            throw e;
          }
        }
      ' &&

      echo '=== Waiting for config server PRIMARY ===' &&
      until mongosh --host configsvr:27019 --quiet --eval \"rs.status().myState\" | grep -q \"1\"; do
        echo \"Waiting for config server to become PRIMARY...\"
        sleep 3
      done &&
      echo \"Config server is PRIMARY\" &&

      echo '=== Initializing Shard1 Replica Set ===' &&
      mongosh --host shard1:27018 --quiet --eval '
        try {
          var status = rs.status();
          print(\"Shard1 already initialized\");
        } catch (e) {
          if (e.codeName === \"NotYetInitialized\") {
            rs.initiate({
              _id: \"shard1ReplSet\",
              members: [{ _id: 0, host: \"shard1:27018\" }]
            });
            print(\"Shard1 replica set initiated\");
          } else {
            throw e;
          }
        }
      ' &&

      echo '=== Waiting for shard1 PRIMARY ===' &&
      until mongosh --host shard1:27018 --quiet --eval \"rs.status().myState\" | grep -q \"1\"; do
        echo \"Waiting for shard1 to become PRIMARY...\"
        sleep 3
      done &&
      echo \"Shard1 is PRIMARY\" &&

      echo '=== Initializing Shard2 Replica Set ===' &&
      mongosh --host shard2:27018 --quiet --eval '
        try {
          var status = rs.status();
          print(\"Shard2 already initialized\");
        } catch (e) {
          if (e.codeName === \"NotYetInitialized\") {
            rs.initiate({
              _id: \"shard2ReplSet\",
              members: [{ _id: 0, host: \"shard2:27018\" }]
            });
            print(\"Shard2 replica set initiated\");
          } else {
            throw e;
          }
        }
      ' &&

      echo '=== Waiting for shard2 PRIMARY ===' &&
      until mongosh --host shard2:27018 --quiet --eval \"rs.status().myState\" | grep -q \"1\"; do
        echo \"Waiting for shard2 to become PRIMARY...\"
        sleep 3
      done &&
      echo \"Shard2 is PRIMARY\" &&

      echo '=== All replica sets initialized and ready ===' &&
      sleep 5
      "
    networks:
      - mongo-net

  # ---------- MONGOS ROUTER ----------
  mongos:
    image: mongo:6.0
    container_name: mongos
    depends_on:
      init-replica-sets:
        condition: service_completed_successfully
    command: mongos --configdb configReplSet/configsvr:27019 --bind_ip_all --port 27017
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - mongo-net
      - backend-net

  # ---------- INIT SHARDING ----------
  init-sharding:
    image: mongo:6.0
    container_name: init-sharding
    depends_on:
      mongos:
        condition: service_healthy
    volumes:
      - ./init-sharding.js:/init-sharding.js:ro
      - ./init-shard-entrypoint.sh:/init-shard-entrypoint.sh:ro
      - shard-dumps:/tmp/shard_dumps
    entrypoint: ["/bin/bash", "/init-shard-entrypoint.sh"]
    environment:
      # set AUTO_CLEAN to "true" if you want the script to dump -> drop -> addShard -> restore automatically
      - AUTO_CLEAN=false
      - MONGOS_HOST=mongos:27017
      - 'SHARD_HOSTS=shard1:27018 shard2:27018'
      - DB_TO_CHECK=banking
    networks:
      - mongo-net


  # ---------- AUTH SERVICE ----------
  auth-service:
    build: ./auth-service
    container_name: auth-service
    depends_on:
      init-sharding:
        condition: service_completed_successfully
      rabbitmq:
        condition: service_healthy
    environment:
      - MONGO_URI=mongodb://mongos:27017
      - JWT_SECRET=your_super_secret_jwt_key_change_in_production
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
    ports:
      - "8000:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
      - mongo-net

  # ---------- ACCOUNT SERVICE ----------
  account-service:
    build: ./account-service
    container_name: account-service
    depends_on:
      auth-service:
        condition: service_healthy
      init-sharding:
        condition: service_completed_successfully
    environment:
      - MONGO_URI=mongodb://mongos:27017
      - JWT_SECRET=your_super_secret_jwt_key_change_in_production
      - AUTH_SERVICE_URL=http://auth-service:8000
    ports:
      - "8001:8001"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
      - mongo-net

  # ---------- TRANSACTION SERVICE ----------
  transaction-service:
    build: ./transaction-service
    container_name: transaction-service
    depends_on:
      account-service:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      - MONGO_URI=mongodb://mongos:27017
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - JWT_SECRET=your_super_secret_jwt_key_change_in_production
      - AUTH_SERVICE_URL=http://auth-service:8000
    ports:
      - "8002:8002"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
      - mongo-net

  # ---------- NOTIFICATION SERVICE ----------
  notification-service:
    build: ./notification-service
    container_name: notification-service
    depends_on:
      rabbitmq:
        condition: service_healthy
      init-sharding:
        condition: service_completed_successfully
    environment:
      - MONGO_URI=mongodb://mongos:27017
      - RABBITMQ_HOST=rabbitmq
      - RABBITMQ_USER=guest
      - RABBITMQ_PASS=guest
      - JWT_SECRET=your_super_secret_jwt_key_change_in_production
      - AUTH_SERVICE_URL=http://auth-service:8000
    ports:
      - "8003:8003"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - backend-net
      - mongo-net

networks:
  backend-net:
    driver: bridge
  mongo-net:
    driver: bridge

volumes:
  configsvr-data:
  shard1-data:
  shard2-data:
  shard-dumps:
